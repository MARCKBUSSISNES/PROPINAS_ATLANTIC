<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Registro de Propinas · Las Piconas</title>

<!-- Librerías CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>

<style>
/* ===========================
   Estética empresarial + animaciones sutiles
   =========================== */
:root{
  --bg:#0b1220;
  --panel: rgba(255,255,255,0.02);
  --accent:#0b7285;
  --accent-2:#0fa3a3;
  --muted:#9fb3b3;
  --glass: rgba(255,255,255,0.02);
  --card-radius:12px;
  --mono: "Courier New", monospace;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Inter", "Poppins", Arial, sans-serif;
  color:#e6f6f6;
  background: linear-gradient(180deg, #071018 0%, #071827 100%);
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}

/* header */
.header{
  display:flex; align-items:center; gap:16px;
  padding:18px 24px; background:rgba(255,255,255,0.02);
  border-bottom:1px solid rgba(255,255,255,0.02);
}
.logo-wrap img{ width:110px; height:auto; object-fit:contain; border-radius:8px; }
.header h1{ margin:0; font-size:1.2rem; color:var(--accent); font-weight:700; }

/* container */
.container{ max-width:1100px; margin:28px auto; padding:20px; border-radius:var(--card-radius);
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
  box-shadow: 0 12px 40px rgba(0,0,0,0.6);
  border:1px solid rgba(255,255,255,0.02);
}

/* form */
.form{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:16px; }
.input, .select, .btn{ padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:var(--glass); color:#e6f6f6; }
.input:focus, .select:focus { outline:none; box-shadow: 0 8px 24px rgba(15,163,163,0.07); transform:translateY(-1px); }
.btn{ cursor:pointer; background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#042; font-weight:700; border:none; }

/* grid */
.grid{ display:grid; grid-template-columns: 1fr 360px; gap:18px; align-items:start; }

/* cards */
.card{ background:transparent; padding:14px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); }
.table-wrap{ max-height:480px; overflow:auto; margin-top:8px; border-radius:8px; }

/* table */
table{ width:100%; border-collapse:collapse; font-size:0.95rem; }
thead th{ position:sticky; top:0; background:rgba(0,0,0,0.2); padding:10px; color:var(--accent); text-align:left; font-weight:700; }
tbody td{ padding:10px; border-top:1px solid rgba(255,255,255,0.02); color:#dff6f6; vertical-align:middle; }
.row-actions button{ margin-right:6px; }

/* right panel */
.side{ display:flex; flex-direction:column; gap:12px; }
.kpi{ padding:12px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.02); }
.kpi strong{ color:var(--accent); font-size:1.1rem; }

/* saved days */
.saved-days{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
.saved-days button{ padding:8px 10px; background:transparent; border:1px solid rgba(255,255,255,0.03); color:var(--muted); border-radius:8px; cursor:pointer; }

/* barcode canvas */
#barcodeCanvas{ display:block; margin-top:8px; max-width:100%; height:70px; }

/* subtle animations */
.fade-in{ animation: fadeInUp .34s ease both; }
@keyframes fadeInUp{ from{ opacity:0; transform:translateY(6px);} to{ opacity:1; transform:none;} }
.btn:hover{ transform: translateY(-3px); box-shadow: 0 10px 30px rgba(10,120,120,0.08); }

/* modal */
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:9999; }
.modal{ width:520px; max-width:94%; background:#071018; padding:18px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); }

/* responsive */
@media(max-width:980px){ .grid{ grid-template-columns: 1fr; } .logo-wrap img{ width:92px; } }
</style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <div class="logo-wrap">
      <img src="LOGO1.png" alt="LOGO1" id="logo1">
    </div>
    <div>
      <h1>Registro de Propinas · Las Piconas</h1>
      <div style="font-size:0.86rem; color:var(--muted)">Ingrese las propinas del dia.</div>
    </div>
    <div style="margin-left:auto; font-family:var(--mono); color:var(--muted)" id="nowLabel"></div>
  </div>

  <!-- APP -->
  <div class="container fade-in">
    <!-- INPUTS -->
    <div class="form">
      <input id="employee" class="input" placeholder="Nombre del empleado">
      <input id="amount" class="input" type="number" placeholder="Monto (Q)" step="0.01" style="max-width:160px">
      <select id="tipType" class="select" style="min-width:140px">
        <option value="Efectivo">Efectivo</option>
        <option value="Tarjeta">Tarjeta</option>
        <option value="Apps">Apps</option>
      </select>
      <input id="note" class="input" placeholder="Observaciones (opcional)">
      <button id="addTip" class="btn">Registrar</button>
      <button id="clearForm" class="input" style="background:transparent;color:var(--muted)">Limpiar</button>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div><strong>Propinas del día</strong><div style="font-size:0.86rem;color:var(--muted)">Guardadas por fecha</div></div>
          <div style="text-align:right"><div style="font-size:0.86rem;color:var(--muted)">Total hoy</div><strong id="totalToday">Q0.00</strong></div>
        </div>

        <div class="table-wrap" style="margin-top:10px">
          <table id="tipsTable" aria-live="polite">
            <thead><tr><th>Empleado</th><th>Monto</th><th>Tipo</th><th>Hora</th><th>Acciones</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="display:flex; gap:8px; margin-top:12px;">
          <button id="exportPdfBtn" class="btn">Exportar (PDF 80mm) y LIMPIAR</button>
          <button id="genTicketAll" class="input" style="background:transparent;color:var(--muted)">Generar tickets (día)</button>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="side">
        <div class="kpi">
          <div>
            <div style="font-size:0.86rem;color:var(--muted)">Fecha activa</div>
            <strong id="activeDate"></strong>
          </div>
          <div>
            <div style="font-size:0.86rem;color:var(--muted)">Registros</div>
            <strong id="countToday">0</strong>
          </div>
        </div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><strong>Listas guardadas</strong><div style="font-size:0.86rem;color:var(--muted)">Cargar por día</div></div>
          </div>
          <div class="saved-days" id="savedDays"></div>
          <div style="margin-top:10px; display:flex; gap:8px;">
            <button id="deleteDayBtn" class="input" style="background:transparent;color:var(--muted)">Borrar Día</button>
            <button id="deleteAllBtn" class="input" style="background:transparent;color:var(--muted)">Borrar Todo</button>
          </div>
        </div>

        <div class="card" style="text-align:center">
          <div style="font-size:0.86rem;color:var(--muted)">Ticket seleccionado</div>
          <canvas id="barcodeCanvas"></canvas>
          <div style="margin-top:8px"><button id="genTicketBtn" class="btn">Generar Ticket</button></div>
        </div>

      </div>
    </div>
  </div>

  <!-- MODAL (simple) -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-hidden="true">
    <div class="modal">
      <div id="modalContent"></div>
      <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:8px;">
        <button id="modalClose" class="input" style="background:transparent;color:var(--muted)">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Sonidos opcionales -->
  <audio id="clickSound" src="sounds/CLICK.mp3" preload="auto"></audio>
  <audio id="vozSound" src="sounds/VOZ.mp3" preload="auto"></audio>

<script>
/* ===========================
   Lógica final solicitada
   - BORRAR individual requiere código secreto: 22782522 (no mostrado)
   - CIERRE/EXPORTAR requiere código secreto: 12345 (no mostrado)
   - LOGO1.png in page, LOGO2.jpg in ticket
   =========================== */

/* Config */
const STORAGE_KEY = "piconas_tips_by_date_v3";
const DELETE_SECRET = "22782522"; // secreto para borrar una propina
const CLOSURE_SECRET = "12345";   // secreto para cierre/impresion y borrado de todo

/* Util */
function uidShort(){
  const t = Date.now().toString(36);
  const r = Math.random().toString(36).slice(2,8);
  return (t + "-" + r).toUpperCase();
}
function moneyFormat(v){ const n = Number(v||0); return "Q" + Number(n).toFixed(2); }
function todayString(){ return (new Date()).toLocaleDateString(); }
function nowTime(){ return (new Date()).toLocaleTimeString(); }
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* State */
let activeDate = todayString();
let tips = []; // items for active date
let selectedIdx = null;

/* DOM */
const employeeInput = document.getElementById('employee');
const amountInput = document.getElementById('amount');
const noteInput = document.getElementById('note');
const tipTypeInput = document.getElementById('tipType');
const addTipBtn = document.getElementById('addTip');
const clearFormBtn = document.getElementById('clearForm');
const tipsTableBody = document.querySelector('#tipsTable tbody');
const totalTodayEl = document.getElementById('totalToday');
const countTodayEl = document.getElementById('countToday');
const activeDateEl = document.getElementById('activeDate');
const savedDaysEl = document.getElementById('savedDays');
const nowLabel = document.getElementById('nowLabel');

const exportPdfBtn = document.getElementById('exportPdfBtn');
const genTicketBtn = document.getElementById('genTicketBtn');
const genTicketAllBtn = document.getElementById('genTicketAll');
const deleteDayBtn = document.getElementById('deleteDayBtn');
const deleteAllBtn = document.getElementById('deleteAllBtn');

const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');
const modalClose = document.getElementById('modalClose');
const barcodeCanvas = document.getElementById('barcodeCanvas');

/* clock */
function updateNow(){ nowLabel.textContent = new Date().toLocaleString(); }
setInterval(updateNow,1000); updateNow();

/* Storage helpers */
function loadAllStorage(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }catch(e){ console.error(e); return {}; } }
function saveAllStorage(obj){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }catch(e){ console.error(e); } }
function persistActive(){ const all = loadAllStorage(); all[activeDate] = tips.slice(); saveAllStorage(all); renderSavedDays(); }

/* Init active date */
function loadActive(date){
  activeDate = date || todayString();
  activeDateEl.textContent = activeDate;
  const all = loadAllStorage();
  tips = (all[activeDate] && Array.isArray(all[activeDate])) ? all[activeDate].slice() : [];
  selectedIdx = null;
  renderTips();
  renderSavedDays();
}

/* Render saved days */
function renderSavedDays(){
  savedDaysEl.innerHTML = "";
  const all = loadAllStorage();
  const keys = Object.keys(all).sort((a,b)=> (new Date(b) - new Date(a)));
  keys.forEach(k=>{
    const btn = document.createElement('button');
    btn.textContent = `${k} (${all[k].length})`;
    btn.onclick = ()=> loadActive(k);
    savedDaysEl.appendChild(btn);
  });
}

/* Render tips table */
function renderTips(){
  tipsTableBody.innerHTML = "";
  let total = 0;
  tips.forEach((t, idx)=>{
    const tr = document.createElement('tr');
    tr.dataset.idx = idx;
    tr.innerHTML = `
      <td>${escapeHtml(t.employee)}</td>
      <td>${moneyFormat(t.amount)}</td>
      <td>${escapeHtml(t.type)}</td>
      <td>${escapeHtml(t.time)}</td>
      <td style="text-align:right">
        <button class="input" data-idx="${idx}" onclick="onGenerateTicket(event)">Ticket</button>
        <button class="input" data-idx="${idx}" onclick="onRequestDelete(event)" style="margin-left:6px;background:transparent;color:var(--muted)">Borrar</button>
      </td>
    `;
    tr.addEventListener('click', ()=> {
      // select and render barcode preview
      const prev = tipsTableBody.querySelector('tr.selected');
      if(prev) prev.classList.remove('selected');
      tr.classList.add('selected');
      selectedIdx = idx;
      try{
        JsBarcode(barcodeCanvas, t.code, {format:'CODE128', width:2, height:40, displayValue:true, fontSize:10});
      }catch(e){}
    });
    tipsTableBody.appendChild(tr);
    total += Number(t.amount||0);
  });
  totalTodayEl.textContent = moneyFormat(total);
  countTodayEl.textContent = String(tips.length);
}

/* Modal helper */
function showModal(html){
  modalContent.innerHTML = html;
  modal.style.display = 'flex';
}
modalClose.addEventListener('click', ()=> modal.style.display = 'none');

/* Add tip - create item WITHOUT exposing any delete codes */
addTipBtn.addEventListener('click', ()=>{
  const emp = employeeInput.value.trim();
  const amt = Number(amountInput.value);
  const type = tipTypeInput.value;
  const note = noteInput.value || "";
  if(!emp || !amt || isNaN(amt) || amt <= 0){ alert("Ingrese nombre de empleado y monto válido."); return; }

  const item = {
    id: uidShort(),
    code: (uidShort().replace(/-/g,'').slice(0,14)),
    // deleteCode intentionally not exposed in UI; using global secret DELETE_SECRET
    employee: emp,
    amount: Number(amt).toFixed(2),
    type: type,
    note: note,
    time: nowTime()
  };

  tips.push(item);
  persistActive();
  renderTips();

  try{ document.getElementById('clickSound').currentTime = 0; document.getElementById('clickSound').play(); }catch(e){}

  // Clear inputs
  employeeInput.value=''; amountInput.value=''; noteInput.value='';
});

/* Request delete per-item: asks for global secret DELETE_SECRET (22782522) */
window.onRequestDelete = function(e){
  e.stopPropagation();
  const idx = Number(e.currentTarget.getAttribute('data-idx'));
  if(!Number.isFinite(idx) || !tips[idx]) return;
  const promptCode = prompt("Introduzca el código secreto para borrar esta propina:");
  if(promptCode === null) return;
  if(promptCode.trim() === DELETE_SECRET){
    // delete
    tips.splice(idx,1);
    persistActive();
    renderTips();
    alert("Propina borrada.");
  } else {
    alert("Código incorrecto. No se ha borrado.");
  }
};

/* Generate single ticket (row button) */
window.onGenerateTicket = function(e){
  e.stopPropagation();
  const idx = Number(e.currentTarget.getAttribute('data-idx'));
  if(!Number.isFinite(idx) || !tips[idx]) return;
  generateTicketPDF(tips[idx]);
};

/* Generate Ticket PDF for one item using LOGO2.jpg (respect aspect ratio) */
async function generateTicketPDF(item){
  try{
    if(!(window.jspdf && window.jspdf.jsPDF)){ alert("jsPDF no disponible."); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'mm', format:[80,220]});
    let y = 6;

    // Draw LOGO2.jpg centered preserving aspect ratio
    const img = new Image();
    img.src = 'LOGO2.jpg';
    await new Promise(res => { img.onload = res; img.onerror = res; });
    try{
      const maxW = 56; // mm
      const ratio = (img.naturalWidth && img.naturalHeight) ? img.naturalWidth / img.naturalHeight : 1;
      let w = maxW, h = w / ratio;
      if(h > 28){ h = 28; w = h * ratio; }
      const x = (80 - w)/2;
      doc.addImage(img, 'JPEG', x, y, w, h);
      y += h + 4;
    }catch(e){ y += 2; }

    doc.setFontSize(10); doc.text("Comprobante de Propina", 40, y, {align:'center'}); y += 6;
    doc.setFontSize(9);
    doc.text(`Empleado: ${item.employee}`, 8, y); y += 5;
    doc.text(`Monto: ${moneyFormat(item.amount)}`, 8, y); y += 5;
    doc.text(`Tipo: ${item.type}`, 8, y); y += 5;
    doc.text(`Fecha: ${activeDate} ${item.time}`, 8, y); y += 6;
    doc.text(`Código: ${item.code}`, 8, y); y += 6;

    // barcode canvas
    const c = document.createElement('canvas'); c.width = 350; c.height = 60;
    try{
      JsBarcode(c, item.code, {format:'CODE128', width:2, height:40, displayValue:false, margin:2});
      const dataUrl = c.toDataURL('image/png');
      doc.addImage(dataUrl, 'PNG', 8, y, 64, 18);
      y += 22;
    }catch(e){ console.warn(e); }

    if(item.note){
      doc.setFontSize(8); doc.text("Obs: " + item.note, 8, y); y += 6;
    }

    doc.setFontSize(8); doc.text("Gracias por su servicio", 40, y, {align:'center'}); y += 6;
    doc.save(`ticket_${item.employee.replace(/\s+/g,'_')}_${item.code}.pdf`);
    try{ document.getElementById('vozSound').currentTime = 0; document.getElementById('vozSound').play(); }catch(e){}
  }catch(err){
    console.error("Error ticket:", err);
    alert("Error generando ticket (ver consola).");
  }
}

/* Generate tickets for all tips of the day sequentially */
document.getElementById('genTicketAll').addEventListener('click', async ()=>{
  if(!tips.length){ alert("No hay registros hoy."); return; }
  if(!confirm("Generar ticket individual para cada registro del día?")) return;
  for(let i=0;i<tips.length;i++){
    await generateTicketPDF(tips[i]);
    await new Promise(r=>setTimeout(r, 220));
  }
});

/* EXPORT PDF 80mm for ALL DATA (requires closure secret). After export delete all data */
exportPdfBtn.addEventListener('click', async ()=>{
  const all = loadAllStorage();
  if(Object.keys(all).length === 0){ alert("No hay registros para exportar."); return; }
  const provided = prompt("Ingrese el código de cierre para exportar e imprimir (código secreto):");
  if(provided === null) return;
  if(provided.trim() !== CLOSURE_SECRET){
    alert("Código de cierre incorrecto.");
    return;
  }

  if(!confirm("Exportar TODOS los registros y totales a un único PDF (80mm). Después de exportar se ELIMINARÁN TODOS LOS DATOS. ¿Continuar?")) return;

  try{
    if(!(window.jspdf && window.jspdf.jsPDF)){ alert("jsPDF no disponible."); return; }
    const { jsPDF } = window.jspdf;

    // Count rows and estimate height
    let rowCount = 0;
    const dayKeys = Object.keys(all).sort((a,b)=> new Date(a) - new Date(b));
    dayKeys.forEach(k => rowCount += (all[k] && all[k].length) ? all[k].length : 0);
    const approxHeight = Math.max(220, 40 + (rowCount * 8) + (dayKeys.length * 14));
    const doc = new jsPDF({unit:'mm', format:[80, approxHeight]});
    let y = 6;

    // Add LOGO2 at top of summary too (optional) - respect aspect ratio
    const logoTop = new Image();
    logoTop.src = 'LOGO2.jpg';
    await new Promise(res => { logoTop.onload = res; logoTop.onerror = res; });
    try{
      const maxW = 56; const ratio = (logoTop.naturalWidth && logoTop.naturalHeight) ? logoTop.naturalWidth / logoTop.naturalHeight : 1;
      let w = maxW, h = w / ratio; if(h > 20){ h = 20; w = h * ratio; }
      const x = (80 - w)/2;
      doc.addImage(logoTop, 'JPEG', x, y, w, h);
      y += h + 4;
    }catch(e){ y += 2; }

    doc.setFontSize(10); doc.text("Cierre de Propinas · Resumen", 40, y, {align:'center'}); y += 6;
    doc.setFontSize(8);
    let grandTotal = 0;

    for(const day of dayKeys){
      const arr = all[day];
      const dayTotal = arr.reduce((s,i)=> s + Number(i.amount||0), 0);
      doc.setFontSize(9); doc.text(`${day} — ${arr.length} registros — Total: ${moneyFormat(dayTotal)}`, 8, y);
      y += 6;
      doc.setFontSize(8);
      doc.text("Empleado", 8, y); doc.text("Monto", 62, y, {align:'right'}); y += 4;
      arr.forEach(it => {
        const emp = it.employee.length > 20 ? it.employee.slice(0,20)+"…" : it.employee;
        doc.text(emp, 8, y); doc.text(moneyFormat(it.amount), 62, y, {align:'right'}); y += 4;
        grandTotal += Number(it.amount||0);
      });
      y += 6;
      // Guard against page overflow - but doc has big height; keep simple
    }

    doc.setFontSize(10); doc.text("Gran Total: " + moneyFormat(grandTotal), 40, y, {align:'center'}); y += 6;
    doc.setFontSize(8); doc.text("Cierre realizado: " + new Date().toLocaleString(), 8, y); y += 6;

    const fn = `Propinas_Cierre_${(new Date()).toISOString().slice(0,10)}.pdf`;
    doc.save(fn);

    // After save: clear storage
    localStorage.removeItem(STORAGE_KEY);
    tips = [];
    loadActive(todayString());
    alert("Exportación completada y datos eliminados del sistema.");
  }catch(err){
    console.error("Export error:", err);
    alert("Error durante la exportación. Revisa la consola.");
  }
});

/* Delete day (requires secret) */
deleteDayBtn.addEventListener('click', ()=>{
  const promptKey = prompt("Introduce el código secreto para borrar la fecha " + activeDate + ":");
  if(promptKey === null) return;
  if(promptKey.trim() !== DELETE_SECRET){ alert("Código incorrecto."); return; }
  if(!confirm("Confirmar borrado del día " + activeDate + "?")) return;
  const all = loadAllStorage();
  delete all[activeDate];
  saveAllStorage(all);
  tips = [];
  loadActive(todayString());
  alert("Día borrado.");
});

/* Delete all (requires secret) */
deleteAllBtn.addEventListener('click', ()=>{
  const promptKey = prompt("Introduce el código secreto para BORRAR TODO:");
  if(promptKey === null) return;
  if(promptKey.trim() !== DELETE_SECRET){ alert("Código incorrecto."); return; }
  if(!confirm("¿Seguro? Se borrarán todos los registros de todas las fechas.")) return;
  localStorage.removeItem(STORAGE_KEY);
  tips = []; loadActive(todayString());
  alert("Todos los datos han sido borrados.");
});

/* Load initial state */
function init(){
  loadActive(todayString());
}
init();

/* Expose small helpers for inline handlers */
window.generateTicketPDF = generateTicketPDF;
window.uidShort = uidShort;

</script>
</body>
</html>
