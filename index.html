<!-- LOGIN COMPONENT: copia esto dentro de tu HTML donde quieras el login -->
<!-- Credenciales por defecto: usuario "admin" / clave "22782522" -->
<style>
  /* Estilos del login (autocontenidos) */
  #loginContainer {
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    background: linear-gradient(120deg, rgba(7,18,24,0.92), rgba(15,32,43,0.92));
    z-index:99999;
  }
  #loginCard{
    width:360px; max-width:94%; padding:28px; border-radius:12px;
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    color:#eaf6f6; font-family:Inter, Poppins, Arial, sans-serif;
  }
  #loginCard h2{ margin:0 0 10px 0; color:#9fe6df; font-size:1.1rem; }
  .login-row{ display:flex; flex-direction:column; gap:8px; margin-top:12px; }
  .login-row input{
    padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04);
    background: rgba(0,0,0,0.25); color: #eaf6f6; font-size:0.95rem;
    outline:none;
  }
  .login-actions{ display:flex; gap:8px; margin-top:14px; align-items:center; }
  .btn-primary{
    flex:1; padding:10px 12px; border-radius:8px; border:none; cursor:pointer;
    background: linear-gradient(180deg,#0b7285,#0fa3a3); color:#021212; font-weight:700;
  }
  .btn-secondary{
    padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06);
    background:transparent; color:var(--muted, #9fb3b3); cursor:pointer;
  }
  #loginError{ color:#ff7b7b; font-size:0.88rem; display:none; margin-top:8px; }
  @media(max-width:420px){ #loginCard{ padding:16px } }
</style>

<div id="loginContainer" aria-hidden="false">
  <div id="loginCard" role="dialog" aria-labelledby="loginTitle" aria-modal="true">
    <h2 id="loginTitle">Acceso al Sistema</h2>
    <div class="login-row">
      <label class="sr-only" for="loginUser">Usuario</label>
      <input id="loginUser" type="text" autocomplete="username" placeholder="Usuario (ej. admin)">
      <label class="sr-only" for="loginPass">Contraseña</label>
      <input id="loginPass" type="password" autocomplete="current-password" placeholder="Contraseña">
    </div>

    <div class="login-actions">
      <button id="loginBtn" class="btn-primary" type="button">Ingresar</button>
      <button id="loginCancel" class="btn-secondary" type="button" title="Cerrar login">Cerrar</button>
    </div>

    <div id="loginError" role="alert">Usuario o contraseña incorrectos.</div>
  </div>
</div>

<script>
/*
  Login simple en cliente (sin base de datos).
  - Usuario por defecto: admin
  - Clave por defecto: 22782522
  - Al ingresar con éxito dispara evento "login-success" en window con detalle {user}
  - Escucha window.addEventListener('login-success', e => { ... }) para iniciar tu app
  - Para ocultar el login manualmente puedes llamar hideLogin()
*/

(function(){
  const DEFAULT_USER = 'naomi';
  const DEFAULT_PASS = '123456789';

  const loginContainer = document.getElementById('loginContainer');
  const userInput = document.getElementById('loginUser');
  const passInput = document.getElementById('loginPass');
  const loginBtn = document.getElementById('loginBtn');
  const cancelBtn = document.getElementById('loginCancel');
  const errEl = document.getElementById('loginError');

  // Autofocus usuario
  setTimeout(()=> userInput.focus(), 120);

  // Mostrar/ocultar helpers
  function showError(msg){
    errEl.textContent = msg || 'Usuario o contraseña incorrectos.';
    errEl.style.display = 'block';
  }
  function hideError(){ errEl.style.display = 'none'; }

  function hideLogin(){
    loginContainer.style.display = 'none';
    loginContainer.setAttribute('aria-hidden','true');
  }
  function showLogin(){
    loginContainer.style.display = 'flex';
    loginContainer.setAttribute('aria-hidden','false');
    userInput.focus();
  }

  // Validación - devuelve true si coincide
  function validateCredentials(u,p){
    // Normalizamos a string y comparamos exactamente con los valores pedidos
    return String(u).trim() === DEFAULT_USER && String(p).trim() === DEFAULT_PASS;
  }

  // Éxito de login: guarda flag y emite evento para app
  function onLoginSuccess(user){
    // marca sesión (puedes cambiar a sessionStorage si prefieres)
    localStorage.setItem('piconas_logged', JSON.stringify({ user, ts: Date.now() }));
    // emitimos evento público con detalle
    const ev = new CustomEvent('login-success', { detail: { user }});
    window.dispatchEvent(ev);
    hideLogin();
  }

  // Manejo botón
  loginBtn.addEventListener('click', ()=>{
    hideError();
    const u = userInput.value || '';
    const p = passInput.value || '';
    if(!u || !p){ showError('Complete usuario y contraseña.'); return; }
    if(validateCredentials(u,p)){
      onLoginSuccess(u.trim());
    } else {
      showError();
    }
  });

  // Enter para enviar
  [userInput, passInput].forEach(inp=>{
    inp.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); loginBtn.click(); }
    });
  });

  // Cancelar / cerrar login (por si quieres mostrar app sin login durante pruebas)
  cancelBtn.addEventListener('click', ()=>{
    hideLogin();
    // emitimos evento "login-cancel" por si la app lo necesita
    window.dispatchEvent(new CustomEvent('login-cancel'));
  });

  // Provee funciones globales útiles (no obligatorias)
  window.LoginComponent = {
    show: showLogin,
    hide: hideLogin,
    isLogged: ()=> {
      try{ return !!JSON.parse(localStorage.getItem('piconas_logged')); }catch(e){return false;}
    },
    logout: ()=> { localStorage.removeItem('piconas_logged'); showLogin(); }
  };

})();
</script>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Registro de Propinas · Las Piconas</title>

<!-- jsPDF & JsBarcode desde CDN (si prefieres locales, me dices y lo cambio) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>

<style>
:root{
  --bg:#071018;
  --panel: rgba(255,255,255,0.02);
  --accent:#0b7285;
  --accent-2:#0fa3a3;
  --muted:#9fb3b3;
  --glass: rgba(255,255,255,0.02);
  --card-radius:12px;
  --text:#e6f6f6;
  --danger:#ff6b6b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Inter, Poppins, Arial, sans-serif; color:var(--text);
  background: linear-gradient(180deg, #04121a 0%, #071827 100%);
  min-height:100vh; display:flex; flex-direction:column;
}
/* Header */
.header{ display:flex; align-items:center; gap:16px; padding:14px 20px; background: rgba(255,255,255,0.01); border-bottom:1px solid rgba(255,255,255,0.02); }
.logo-wrap img{ width:110px; height:auto; object-fit:contain; border-radius:6px; }
.header h1{ margin:0; font-size:1.05rem; color:var(--accent); font-weight:700; }

/* Container */
.container{ max-width:1100px; margin:22px auto; padding:18px; border-radius:var(--card-radius);
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
  box-shadow: 0 12px 40px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.02);
}

/* Form */
.form{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:14px; }
.input, .select, .btn{ padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:var(--glass); color:var(--text); }
.btn{ cursor:pointer; background: linear-gradient(180deg,var(--accent),var(--accent-2)); color:#021; font-weight:700; border:none; }
.input[disabled]{ opacity:0.6 }

/* Grid */
.grid{ display:grid; grid-template-columns:1fr 360px; gap:16px; align-items:start; }
.card{ background:transparent; padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); }

/* Table */
.table-wrap{ max-height:460px; overflow:auto; margin-top:8px; border-radius:8px; }
table{ width:100%; border-collapse:collapse; font-size:0.95rem; }
thead th{ position:sticky; top:0; background:rgba(0,0,0,0.2); padding:10px; color:var(--accent); text-align:left; font-weight:700; }
tbody td{ padding:10px; border-top:1px solid rgba(255,255,255,0.02); color:#dff6f6; vertical-align:middle; }

/* Side */
.side{ display:flex; flex-direction:column; gap:12px; }
.kpi{ padding:12px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); border:1px solid rgba(255,255,255,0.02); }
.kpi strong{ color:var(--accent); font-size:1.1rem; }

/* Saved days */
.saved-days{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
.saved-days button{ padding:8px 10px; background:transparent; border:1px solid rgba(255,255,255,0.03); color:var(--muted); border-radius:8px; cursor:pointer; }

/* Barcode canvas */
#barcodeCanvas{ display:block; margin-top:8px; max-width:100%; height:70px; }

/* Footer */
.footer{ margin-top:auto; padding:10px 12px; text-align:center; font-size:0.9rem; color:var(--muted); border-top:1px solid rgba(255,255,255,0.02); }
.footer .signature{ display:inline-block; padding:6px 10px; border-radius:8px; transition: box-shadow .36s ease, transform .28s ease, color .28s ease; cursor:default; }
.footer .signature:hover{ box-shadow: 0 8px 40px rgba(15,163,163,0.28); transform: translateY(-4px) scale(1.01); color:#fff; }

/* Modal (historial) */
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:9999; }
.modal{ width:720px; max-width:94%; max-height:86vh; overflow:auto; background:#071018; padding:18px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); transform: translateY(12px); opacity:0; transition: all .26s cubic-bezier(.22,.9,.3,1); }
.modal.show{ transform:none; opacity:1; }

/* Session blocked overlay */
#sessionBlock{ position:fixed; inset:0; background:rgba(0,0,0,0.72); display:none; z-index:10000; align-items:center; justify-content:center; color:#fff; padding:18px; text-align:center; }
.sessionBox{ background:#071018; padding:20px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); max-width:520px; }

/* small helpers */
.small{ font-size:0.88rem; color:var(--muted); }
.compact-history{ margin-top:10px; font-size:0.88rem; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; }
.compact-card{ background:rgba(255,255,255,0.02); padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.02); }

@media(max-width:980px){ .grid{ grid-template-columns:1fr; } .logo-wrap img{ width:92px; } .modal{ width:92%; } }
</style>
</head>
<body>
  <div class="header">
    <div class="logo-wrap"><img src="LOGO1.png" alt="LOGO1" id="logo1"></div>
    <div>
      <h1>Registro de Propinas · Las Piconas</h1>
      <div class="small">Ingrese las Propinas del dia.</div>
    </div>
    <div style="margin-left:auto; font-family:'Courier New', monospace; color:var(--muted)" id="nowLabel"></div>
  </div>

  <div class="container" id="mainApp">
    <div class="form">
      <input id="employee" class="input" placeholder="Nombre del empleado" />
      <input id="amount" class="input" type="number" placeholder="Monto (Q)" step="0.01" style="max-width:160px" />
      <select id="tipType" class="select" style="min-width:140px">
        <option value="Efectivo">Efectivo</option>
        <option value="Tarjeta">Tarjeta</option>
        <option value="Apps">.</option>
      </select>
      <input id="note" class="input" placeholder="Observaciones (opcional)" />
      <button id="addTip" class="btn">Registrar</button>
      <button id="clearForm" class="input" style="background:transparent;color:var(--muted)">Limpiar</button>
    </div>

    <div class="grid">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div><strong>Propinas del día</strong><div class="small">Guardadas por fecha</div></div>
          <div style="text-align:right"><div class="small">Total hoy</div><strong id="totalToday">Q0.00</strong></div>
        </div>

        <div class="table-wrap" style="margin-top:10px">
          <table id="tipsTable" aria-live="polite">
            <thead><tr><th>Empleado</th><th>Monto</th><th>Tipo</th><th>Hora</th><th style="text-align:right">Acciones</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div style="display:flex; gap:8px; margin-top:12px; align-items:center;">
          <button id="exportPdfBtn" class="btn">Exportar</button>
          <button id="genTicketAll" class="input" style="background:transparent;color:var(--muted)">Generar tickets (día)</button>
          <button id="openHistoryBtn" class="input" style="background:transparent;color:var(--muted); margin-left:auto">Ver Historial</button>
        </div>

        <!-- resumen compacto de historial (últimos 3) -->
        <div class="compact-history" id="compactHistory"></div>
      </div>

      <div class="side">
        <div class="kpi">
          <div><div class="small">Fecha activa</div><strong id="activeDate"></strong></div>
          <div><div class="small">Registros</div><strong id="countToday">0</strong></div>
        </div>

        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div><strong>Listas guardadas</strong><div class="small">Cargar por día</div></div>
          </div>
          <div class="saved-days" id="savedDays"></div>
          <div style="margin-top:10px; display:flex; gap:8px;">
            <button id="deleteDayBtn" class="input" style="background:transparent;color:var(--muted)">Borrar Día</button>
            <button id="deleteAllBtn" class="input" style="background:transparent;color:var(--muted)">Borrar Todo</button>
          </div>
        </div>

        <div class="card" style="text-align:center">
          <div class="small">Ticket seleccionado</div>
          <canvas id="barcodeCanvas"></canvas>
          <div style="margin-top:8px"><button id="genTicketBtn" class="btn">Generar Ticket</button></div>
        </div>

      </div>
    </div>
  </div>

  <div class="footer">
    <div class="signature" title="Derechos reservados">
      © 2025 Marck Business —  Todos los derechos reservados.
    </div>
  </div>

  <!-- modal historial -->
  <div id="historyModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" id="historyBox">
      <h2>Historial de cierres</h2>
      <div id="historyList" style="margin-top:12px"></div>
      <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
        <button id="clearHistoryBtn" class="input" style="background:transparent;color:var(--muted)">Limpiar historial</button>
        <button id="closeHistoryBtn" class="input" style="background:transparent;color:var(--muted)">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- session blocked overlay -->
  <div id="sessionBlock" style="display:none;align-items:center;justify-content:center;">
    <div class="sessionBox">
      <h3>Sesión activa detectada</h3>
      <p class="small">El sistema ya está abierto en otra pestaña o ventana. Para evitar inconsistencias solo se permite una sesión activa.</p>
      <p class="small">Si necesitas tomar control desde esta ventana, puedes forzar la toma (requiere clave administrativa).</p>
      <div style="margin-top:12px; display:flex; gap:8px; justify-content:center;">
        <button id="forceTakeBtn" class="btn">Forzar toma (admin)</button>
        <button id="retryCheckBtn" class="input" style="background:transparent;color:var(--muted)">Volver a comprobar</button>
      </div>
      <div style="margin-top:10px;"><button id="openExistingBtn" class="input" style="background:transparent;color:var(--muted)">Mostrar pestaña existente (si está visible)</button></div>
    </div>
  </div>

  <!-- Sonidos -->
  <audio id="clickSound" src="sounds/CLICK.mp3" preload="auto"></audio>
  <audio id="vozSound" src="sounds/VOZ.mp3" preload="auto"></audio>

<script>
/* -------------------------------------------------------------------------
   Código principal (extensión del que ya te funcionaba)
   - agrega historial de cierres (localStorage)
   - agrega mecanismo de "sesión única" (lock + BroadcastChannel alert)
   ------------------------------------------------------------------------- */

const STORAGE_KEY = "piconas_tips_by_date_v6";
const HISTORY_KEY = "piconas_closure_history_v1";
const DELETE_SECRET = "22782522";
const CLOSURE_SECRET = "12345";

function uidShort(){ const t = Date.now().toString(36); const r = Math.random().toString(36).slice(2,8); return (t + "-" + r).toUpperCase(); }
function moneyFormat(v){ const n = Number(v||0); return "Q" + Number(n).toFixed(2); }
function todayString(){ return (new Date()).toLocaleDateString(); }
function nowTime(){ return (new Date()).toLocaleTimeString(); }
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* DOM */
const employeeInput = document.getElementById('employee');
const amountInput = document.getElementById('amount');
const noteInput = document.getElementById('note');
const tipTypeInput = document.getElementById('tipType');
const addTipBtn = document.getElementById('addTip');
const clearFormBtn = document.getElementById('clearForm');
const tipsTableBody = document.querySelector('#tipsTable tbody');
const totalTodayEl = document.getElementById('totalToday');
const countTodayEl = document.getElementById('countToday');
const activeDateEl = document.getElementById('activeDate');
const savedDaysEl = document.getElementById('savedDays');
const nowLabel = document.getElementById('nowLabel');
const exportPdfBtn = document.getElementById('exportPdfBtn');
const genTicketBtn = document.getElementById('genTicketBtn');
const genTicketAllBtn = document.getElementById('genTicketAll');
const deleteDayBtn = document.getElementById('deleteDayBtn');
const deleteAllBtn = document.getElementById('deleteAllBtn');
const barcodeCanvas = document.getElementById('barcodeCanvas');

const openHistoryBtn = document.getElementById('openHistoryBtn');
const historyModal = document.getElementById('historyModal');
const historyBox = document.getElementById('historyBox');
const historyList = document.getElementById('historyList');
const closeHistoryBtn = document.getElementById('closeHistoryBtn');
const clearHistoryBtn = document.getElementById('clearHistoryBtn');
const compactHistory = document.getElementById('compactHistory');

const sessionBlock = document.getElementById('sessionBlock');
const forceTakeBtn = document.getElementById('forceTakeBtn');
const retryCheckBtn = document.getElementById('retryCheckBtn');
const openExistingBtn = document.getElementById('openExistingBtn');

let activeDate = todayString();
let tips = [];
let selectedIdx = null;

/* now label */
function updateNow(){ nowLabel.textContent = new Date().toLocaleString(); }
setInterval(updateNow,1000); updateNow();

/* storage helpers */
function loadAllStorage(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }catch(e){ console.error(e); return {}; } }
function saveAllStorage(obj){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }catch(e){ console.error(e); } }

function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]"); }catch(e){ console.error(e); return []; } }
function saveHistory(arr){ try{ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr)); }catch(e){ console.error(e); } }

/* persist active day */
function persistActive(){ const all = loadAllStorage(); all[activeDate] = tips.slice(); saveAllStorage(all); renderSavedDays(); }

/* load day */
function loadActive(date){
  activeDate = date || todayString();
  activeDateEl.textContent = activeDate;
  const all = loadAllStorage();
  tips = (all[activeDate] && Array.isArray(all[activeDate])) ? all[activeDate].slice() : [];
  selectedIdx = null;
  renderTips();
  renderSavedDays();
  renderCompactHistory();
}

/* saved days UI */
function renderSavedDays(){
  savedDaysEl.innerHTML = "";
  const all = loadAllStorage();
  const keys = Object.keys(all).sort((a,b)=> (new Date(b) - new Date(a)));
  keys.forEach(k=>{
    const btn = document.createElement('button');
    btn.textContent = `${k} (${ (all[k] || []).length })`;
    btn.addEventListener('click', ()=> loadActive(k));
    savedDaysEl.appendChild(btn);
  });
}

/* render tips table */
function renderTips(){
  tipsTableBody.innerHTML = "";
  let total = 0;
  tips.forEach((t, idx)=>{
    const tr = document.createElement('tr');
    tr.dataset.idx = idx;
    tr.innerHTML = `
      <td>${escapeHtml(t.employee)}</td>
      <td>${moneyFormat(t.amount)}</td>
      <td>${escapeHtml(t.type)}</td>
      <td>${escapeHtml(t.time)}</td>
      <td style="text-align:right">
        <button class="input btn-mini" data-idx="${idx}" data-action="ticket">Ticket</button>
        <button class="input btn-mini" data-idx="${idx}" data-action="delete" style="margin-left:6px;background:transparent;color:var(--muted)">Borrar</button>
      </td>
    `;
    tr.addEventListener('click', ()=> {
      const prev = tipsTableBody.querySelector('tr.selected');
      if(prev) prev.classList.remove('selected');
      tr.classList.add('selected');
      selectedIdx = idx;
      try{ JsBarcode(barcodeCanvas, t.code, {format:'CODE128', width:2, height:40, displayValue:true, fontSize:10}); }catch(e){}
    });
    tr.querySelectorAll('button').forEach(b => {
      b.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        const i = Number(b.getAttribute('data-idx'));
        const action = b.getAttribute('data-action');
        if(action === 'ticket'){ generateTicketPDF(tips[i]); }
        if(action === 'delete'){ requestDelete(i); }
      });
    });
    tipsTableBody.appendChild(tr);
    total += Number(t.amount||0);
  });
  totalTodayEl.textContent = moneyFormat(total);
  countTodayEl.textContent = String(tips.length);
}

/* add tip */
addTipBtn.addEventListener('click', ()=>{
  const emp = employeeInput.value.trim();
  const amt = Number(amountInput.value);
  const type = tipTypeInput.value;
  const note = noteInput ? (noteInput.value || "") : "";
  if(!emp || !amt || isNaN(amt) || amt <= 0){ alert("Ingrese nombre de empleado y monto válido."); return; }
  const item = {
    id: uidShort(),
    code: uidShort().replace(/-/g,'').slice(0,14),
    employee: emp,
    amount: Number(amt).toFixed(2),
    type: type,
    note: note,
    time: nowTime()
  };
  tips.push(item);
  persistActive();
  renderTips();
  try{ clickSound.currentTime = 0; clickSound.play(); }catch(e){}
  employeeInput.value = '';
  amountInput.value = '';
  noteInput.value = '';
  employeeInput.focus();
});

/* clear form */
clearFormBtn.addEventListener('click', ()=>{
  employeeInput.value = '';
  amountInput.value = '';
  noteInput.value = '';
  tipTypeInput.value = 'Efectivo';
  employeeInput.focus();
});

/* delete request - needs DELETE_SECRET */
function requestDelete(idx){
  if(!Number.isFinite(idx) || !tips[idx]) return;
  const promptCode = prompt("Introduzca el código secreto para borrar esta propina:");
  if(promptCode === null) return;
  if(promptCode.trim() === DELETE_SECRET){
    tips.splice(idx,1);
    persistActive();
    renderTips();
    alert("Propina borrada.");
  } else {
    alert("Código incorrecto. No se ha borrado.");
  }
}

/* ticket generation (single) */
async function generateTicketPDF(item){
  try{
    if(!(window.jspdf && window.jspdf.jsPDF)){ alert("jsPDF no disponible."); return; }
    const { jsPDF } = window.jspdf;
    const img = new Image();
    img.src = 'LOGO2.jpg';
    await new Promise(res => { img.onload = res; img.onerror = res; });

    const maxWmm = 66;
    const dpi = 96;
    let logoWmm = maxWmm;
    let ratio = (img.naturalWidth && img.naturalHeight) ? img.naturalWidth / img.naturalHeight : 1;
    let logoHmm = logoWmm / ratio;
    if(logoHmm > 50){ logoHmm = 50; logoWmm = logoHmm * ratio; }

    const lineHeight = 5;
    let estimatedHeight = 8 + logoHmm + 4 + (6 * lineHeight) + 22 + 8;
    if(!item.note) estimatedHeight -= lineHeight;
    estimatedHeight = Math.max(80, Math.ceil(estimatedHeight));
    const doc = new jsPDF({unit:'mm', format:[80, estimatedHeight]});
    let y = 6;

    try{
      const x = (80 - logoWmm) / 2;
      doc.addImage(img, 'JPEG', x, y, logoWmm, logoHmm);
      y += logoHmm + 4;
    }catch(e){ y += 2; }

    doc.setFontSize(11); doc.text("Comprobante de Propina", 40, y, {align:'center'}); y += 6;
    doc.setFontSize(9);
    doc.text(`Empleado: ${item.employee}`, 8, y); y += 5;
    doc.text(`Monto: ${moneyFormat(item.amount)}`, 8, y); y += 5;
    doc.text(`Tipo: ${item.type}`, 8, y); y += 5;
    doc.text(`Fecha: ${activeDate} ${item.time}`, 8, y); y += 6;
    doc.text(`Código: ${item.code}`, 8, y); y += 6;

    const c = document.createElement('canvas'); c.width = 520; c.height = 90;
    try{
      JsBarcode(c, item.code, {format:'CODE128', width:2, height:40, displayValue:false, margin:2});
      const dataUrl = c.toDataURL('image/png');
      const bw = 64; const bx = (80 - bw)/2;
      doc.addImage(dataUrl, 'PNG', bx, y, bw, 18);
      y += 22;
    }catch(e){ console.warn(e); }

    if(item.note){
      doc.setFontSize(8); doc.text("Obs: " + item.note, 8, y); y += 6;
    }

    doc.setFontSize(8); doc.text("Gracias por su servicio", 40, y, {align:'center'}); y += 6;

    const filename = `ticket_${item.employee.replace(/\s+/g,'_')}_${item.code}.pdf`;
    doc.save(filename);
    try{ vozSound.currentTime = 0; vozSound.play(); }catch(e){}
  }catch(err){
    console.error("Error ticket:", err);
    alert("Error generando ticket (ver consola).");
  }
}

/* genTicket for selected row */
genTicketBtn.addEventListener('click', ()=>{
  if(selectedIdx === null || !tips[selectedIdx]){ alert("Seleccione una fila para generar el ticket."); return; }
  generateTicketPDF(tips[selectedIdx]);
});

/* generate all tickets */
genTicketAllBtn.addEventListener('click', async ()=>{
  if(!tips.length){ alert("No hay registros hoy."); return; }
  if(!confirm("Generar ticket individual para cada registro del día?")) return;
  for(let i=0;i<tips.length;i++){
    await generateTicketPDF(tips[i]);
    await new Promise(r=>setTimeout(r,200));
  }
});

/* ------------ CIERRE / EXPORT (agregamos historial) ------------ */
exportPdfBtn.addEventListener('click', async ()=>{
  const all = loadAllStorage();
  if(Object.keys(all).length === 0){ alert("No hay registros para exportar."); return; }
  const provided = prompt("Ingrese el código de cierre para exportar e imprimir (código secreto):");
  if(provided === null) return;
  if(provided.trim() !== CLOSURE_SECRET){ alert("Código de cierre incorrecto."); return; }
  if(!confirm("Exportar TODOS los registros y totales a un único PDF (80mm). Después de exportar se ELIMINARÁN TODOS LOS DATOS. ¿Continuar?")) return;

  try{
    if(!(window.jspdf && window.jspdf.jsPDF)){ alert("jsPDF no disponible."); return; }
    const { jsPDF } = window.jspdf;
    let rowCount = 0;
    const dayKeys = Object.keys(all).sort((a,b)=> new Date(a) - new Date(b));
    dayKeys.forEach(k => rowCount += (all[k] && all[k].length) ? all[k].length : 0);
    const approxHeight = Math.max(200, 40 + (rowCount * 8) + (dayKeys.length * 14));
    const doc = new jsPDF({unit:'mm', format:[80, approxHeight]});
    let y = 6;

    const logoTop = new Image(); logoTop.src = 'LOGO2.jpg';
    await new Promise(res => { logoTop.onload = res; logoTop.onerror = res; });
    try{
      const maxW = 56; const ratio = (logoTop.naturalWidth && logoTop.naturalHeight) ? logoTop.naturalWidth / logoTop.naturalHeight : 1;
      let w = maxW, h = w / ratio; if(h > 20){ h = 20; w = h * ratio; }
      const x = (80 - w)/2; doc.addImage(logoTop, 'JPEG', x, y, w, h); y += h + 4;
    }catch(e){ y += 2; }

    doc.setFontSize(10); doc.text("Cierre de Propinas · Resumen", 40, y, {align:'center'}); y += 6;
    doc.setFontSize(8);
    let grandTotal = 0;
    for(const day of dayKeys){
      const arr = all[day] || [];
      const dayTotal = arr.reduce((s,i)=> s + Number(i.amount||0), 0);
      doc.setFontSize(9); doc.text(`${day} — ${arr.length} registros — Total: ${moneyFormat(dayTotal)}`, 8, y); y += 6;
      doc.setFontSize(8);
      doc.text("Empleado", 8, y); doc.text("Monto", 62, y, {align:'right'}); y += 4;
      arr.forEach(it => {
        const emp = it.employee.length > 20 ? it.employee.slice(0,20)+"…" : it.employee;
        doc.text(emp, 8, y);
        doc.text(moneyFormat(it.amount), 62, y, {align:'right'});
        y += 4;
        grandTotal += Number(it.amount||0);
      });
      y += 6;
    }

    doc.setFontSize(10); doc.text("Gran Total: " + moneyFormat(grandTotal), 40, y, {align:'center'}); y += 6;
    doc.setFontSize(8); doc.text("Cierre realizado: " + new Date().toLocaleString(), 8, y); y += 6;
    const fn = `Propinas_Cierre_${(new Date()).toISOString().slice(0,10)}.pdf`;
    doc.save(fn);

    // Guardar resumen en historial (fecha, hora, total, cantidad)
    const history = loadHistory();
    history.unshift({
      id: uidShort(),
      date: (new Date()).toLocaleDateString(),
      time: (new Date()).toLocaleTimeString(),
      total: grandTotal,
      count: rowCount
    });
    // limit history to last 200 records (evitar crecimiento infinito)
    while(history.length > 200) history.pop();
    saveHistory(history);
    renderCompactHistory();

    // delete everything after exporting
    localStorage.removeItem(STORAGE_KEY);
    tips = [];
    loadActive(todayString());
    alert("Exportación completada y datos eliminados del sistema.");
  }catch(err){
    console.error("Export error:", err);
    alert("Error durante la exportación. Revisa la consola.");
  }
});

/* borrar día actual (DELETE_SECRET) */
deleteDayBtn.addEventListener('click', ()=>{
  const promptKey = prompt("Introduce el código secreto para borrar la fecha " + activeDate + ":");
  if(promptKey === null) return;
  if(promptKey.trim() !== DELETE_SECRET){ alert("Código incorrecto."); return; }
  if(!confirm("Confirmar borrado del día " + activeDate + "?")) return;
  const all = loadAllStorage();
  delete all[activeDate];
  saveAllStorage(all);
  tips = [];
  loadActive(todayString());
  alert("Día borrado.");
});

/* borrar todo (DELETE_SECRET) */
deleteAllBtn.addEventListener('click', ()=>{
  const promptKey = prompt("Introduce el código secreto para BORRAR TODO:");
  if(promptKey === null) return;
  if(promptKey.trim() !== DELETE_SECRET){ alert("Código incorrecto."); return; }
  if(!confirm("¿Seguro? Se borrarán todos los registros de todas las fechas.")) return;
  localStorage.removeItem(STORAGE_KEY);
  tips = [];
  loadActive(todayString());
  alert("Todos los datos han sido borrados.");
});

/* -------------------------
   Historial modal controls
   ------------------------- */
openHistoryBtn.addEventListener('click', ()=> {
  renderHistoryModal();
  historyModal.style.display = 'flex';
  setTimeout(()=> historyBox.classList.add('show'), 10);
});
closeHistoryBtn.addEventListener('click', ()=> {
  historyBox.classList.remove('show');
  setTimeout(()=> historyModal.style.display = 'none', 260);
});
clearHistoryBtn.addEventListener('click', ()=> {
  if(!confirm('Limpiar todo el historial de cierres? Esta acción es irreversible.')) return;
  saveHistory([]);
  renderHistoryModal();
  renderCompactHistory();
});

/* render historial en modal */
function renderHistoryModal(){
  const history = loadHistory();
  if(!history || history.length === 0){
    historyList.innerHTML = '<div class="small">No hay cierres registrados.</div>';
    return;
  }
  historyList.innerHTML = '';
  const ul = document.createElement('div');
  history.slice(0,200).forEach(h=>{
    const d = document.createElement('div');
    d.className = 'small';
    d.style.padding = '8px';
    d.style.borderBottom = '1px solid rgba(255,255,255,0.02)';
    d.innerHTML = `<strong>${h.date} ${h.time}</strong> — Total: ${moneyFormat(h.total)} — Items: ${h.count}`;
    ul.appendChild(d);
  });
  historyList.appendChild(ul);
}

/* compact history (last 3) shown under main card */
function renderCompactHistory(){
  const history = loadHistory();
  compactHistory.innerHTML = '';
  if(!history || history.length === 0){
    compactHistory.innerHTML = '<div class="small">Sin cierres recientes.</div>';
    return;
  }
  history.slice(0,3).forEach(h=>{
    const card = document.createElement('div');
    card.className = 'compact-card';
    card.innerHTML = `<div style="font-weight:700">${h.date}</div><div class="small">${h.time} — ${moneyFormat(h.total)}</div>`;
    compactHistory.appendChild(card);
  });
}

/* -------------------------
   Sesión única (lock + BroadcastChannel)
   - lock stored in localStorage under "piconas_lock"
   - active tab refreshes lock periodically
   - new tabs detect lock and show overlay
   ------------------------- */

const INSTANCE_ID = uidShort();
const LOCK_KEY = 'piconas_lock_v1';
const LOCK_TTL = 5000; // ms - consider active if updated within this
let lockInterval = null;
let isActiveSession = false;
let bc = null;

/* helper to set lock (active tab) */
function claimLock(){
  const payload = { id: INSTANCE_ID, ts: Date.now() };
  localStorage.setItem(LOCK_KEY, JSON.stringify(payload));
  // broadcast presence
  try{ if(!bc) bc = new BroadcastChannel('piconas_channel'); bc.postMessage({ type:'i-am-active', id: INSTANCE_ID }); }catch(e){}
  isActiveSession = true;
  // refresh every 2s
  if(lockInterval) clearInterval(lockInterval);
  lockInterval = setInterval(()=> {
    const p = { id: INSTANCE_ID, ts: Date.now() };
    try{ localStorage.setItem(LOCK_KEY, JSON.stringify(p)); }catch(e){}
    try{ if(bc) bc.postMessage({ type:'i-am-active', id: INSTANCE_ID }); }catch(e){}
  }, 2000);
}

/* release lock (on unload) */
function releaseLock(){
  try{
    const cur = JSON.parse(localStorage.getItem(LOCK_KEY) || '{}');
    if(cur && cur.id === INSTANCE_ID){
      localStorage.removeItem(LOCK_KEY);
      try{ if(bc) bc.postMessage({ type:'i-am-not-active', id: INSTANCE_ID }); }catch(e){}
    }
  }catch(e){}
  isActiveSession = false;
  if(lockInterval) clearInterval(lockInterval);
}

/* check lock and act accordingly (called on load) */
function checkLockOnStart(){
  try{
    const raw = localStorage.getItem(LOCK_KEY);
    if(!raw){
      // no lock -> take it
      claimLock();
      return true;
    }
    const obj = JSON.parse(raw);
    const age = Date.now() - (obj.ts || 0);
    if(age > LOCK_TTL){
      // stale -> takeover
      claimLock();
      return true;
    }
    // exists and fresh -> another tab active
    showSessionBlocked();
    // ping active tab to notify (using BroadcastChannel)
    try{ if(!bc) bc = new BroadcastChannel('piconas_channel'); bc.postMessage({ type:'ping-new-tab', from: INSTANCE_ID }); }catch(e){}
    return false;
  }catch(e){
    claimLock();
    return true;
  }
}

/* show overlay blocking UI in new tab */
function showSessionBlocked(){
  sessionBlock.style.display = 'flex';
  // disable main app interactions
  document.getElementById('mainApp').style.filter = 'blur(2px) brightness(.6)';
}

/* hide overlay when takeover done */
function hideSessionBlocked(){
  sessionBlock.style.display = 'none';
  document.getElementById('mainApp').style.filter = '';
}

/* BroadcastChannel message handling */
function setupBroadcast(){
  try{
    if(!bc) bc = new BroadcastChannel('piconas_channel');
    bc.onmessage = (ev) => {
      const msg = ev.data;
      if(!msg || !msg.type) return;
      if(msg.type === 'ping-new-tab'){
        // a new tab asks for attention -> flash title
        flashTitleOnce('Otra sesión quiere acceso');
      }
      if(msg.type === 'i-am-active'){
        // someone announces they are active - if we are also active and not same id, decide (keep existing)
        // no action necessary
      }
      if(msg.type === 'force-take' && msg.from){
        // another tab forced takeover -> if it's not us, and we were active, release lock
        if(msg.from !== INSTANCE_ID){
          // if we were active, and another asks to take, release
          if(isActiveSession){
            releaseLock();
          }
        }
      }
    };
  }catch(e){
    // BroadcastChannel may not be available in some environments
    console.warn('BroadcastChannel not available', e);
  }
}

/* flash title as attention getter */
let originalTitle = document.title;
let flashTimer = null;
function flashTitleOnce(msg){
  let times = 0;
  if(flashTimer) clearInterval(flashTimer);
  flashTimer = setInterval(()=> {
    document.title = (document.title === originalTitle) ? msg : originalTitle;
    times++;
    if(times > 6){ clearInterval(flashTimer); document.title = originalTitle; }
  }, 500);
}

/* force takeover action (from blocked tab) */
forceTakeBtn.addEventListener('click', ()=>{
  const code = prompt('Introduzca clave administrativa para forzar toma de la sesión (no se muestra):');
  if(code === null) return;
  if(code.trim() !== DELETE_SECRET){ alert('Clave incorrecta.'); return; }
  // announce takeover and claim lock
  try{ if(!bc) bc = new BroadcastChannel('piconas_channel'); bc.postMessage({ type:'force-take', from: INSTANCE_ID }); }catch(e){}
  claimLock();
  hideSessionBlocked();
  alert('Has forzado la toma de la sesión desde esta pestaña.');
});

/* retry check button */
retryCheckBtn.addEventListener('click', ()=> {
  const ok = checkLockOnStart();
  if(ok) {
    hideSessionBlocked();
    alert('Esta pestaña ahora es la sesión activa.');
  } else {
    alert('Aún hay una sesión activa en otra pestaña. Intenta forzar si tienes clave admin.');
  }
});

/* openExistingBtn: tries to notify existing tab to show itself (flash title) */
openExistingBtn.addEventListener('click', ()=> {
  try{ if(!bc) bc = new BroadcastChannel('piconas_channel'); bc.postMessage({ type:'ping-new-tab', from: INSTANCE_ID }); }catch(e){}
  alert('Se ha notificado a la sesión activa para que llame tu atención (si está en el mismo navegador).');
});

/* cleanup on unload */
window.addEventListener('beforeunload', ()=> {
  releaseLock();
});

/* initialize BC and lock on start */
setupBroadcast();
checkLockOnStart(); // takes lock if none or stale

/* -------------------------
   Historial UI initial render
   ------------------------- */
renderCompactHistory();
loadActive(todayString());

/* expose small helpers */
window._piconas = { loadAllStorage, saveAllStorage, loadHistory, saveHistory };

/* end of script */
</script>
</body>
</html>
